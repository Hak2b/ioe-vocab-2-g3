<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i T√¨m T·ª´ Ch√≠nh X√°c (B·ªô 2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            touch-action: manipulation;
        }
        .letter-btn {
            transition: all 0.2s ease-in-out;
            border-bottom-width: 4px;
        }
        .letter-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .letter-btn:active {
            transform: translateY(1px);
            border-bottom-width: 2px;
        }
        .letter-btn.removed {
            opacity: 0.2;
            transform: scale(0.9);
            pointer-events: none;
        }
        .correct-word .letter-btn {
            background-color: #22c55e; /* green-500 */
            border-color: #15803d; /* green-700 */
            color: white;
        }
        .incorrect {
            animation: shake-horizontal 0.5s;
        }
        @keyframes shake-horizontal {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        #fireworks-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-teal-100 flex items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-2xl mx-auto">

        <!-- M√†n h√¨nh b·∫Øt ƒë·∫ßu -->
        <div id="start-screen" class="text-center bg-white p-8 rounded-2xl shadow-xl">
            <h1 class="text-4xl font-bold text-teal-600 mb-4">Th·ª≠ Th√°ch T√¨m T·ª´ (B·ªô 2)</h1>
            <p class="text-gray-600 mb-6">Nh·∫≠p t√™n c·ªßa b·∫°n v√† b·∫Øt ƒë·∫ßu lo·∫°i b·ªè nh·ªØng ch·ªØ c√°i th·ª´a!</p>
            
            <!-- Lu·∫≠t ch∆°i -->
            <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-6 text-left text-gray-700">
                <h3 class="font-bold text-lg text-teal-700 mb-2 text-center">Lu·∫≠t Ch∆°i</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li>Lo·∫°i b·ªè c√°c ch·ªØ c√°i <b class="text-red-500">th·ª´a</b> ƒë·ªÉ t·∫°o th√†nh t·ª´ ti·∫øng Anh ƒë√∫ng.</li>
                    <li>B·∫°n ch·ªâ c√≥ <b class="text-red-500">m·ªôt l·∫ßn</b> b·∫•m sai (b·∫•m v√†o ch·ªØ c√°i ƒë√∫ng).</li>
                    <li>B·∫•m gi·ªØ n√∫t <b class="text-amber-500">G·ª£i √Ω</b> ƒë·ªÉ xem nghƒ©a ti·∫øng Vi·ªát.</li>
                </ul>
            </div>

            <input type="text" id="player-name-input" placeholder="T√™n ng∆∞·ªùi ch∆°i" class="w-full max-w-sm mx-auto text-center text-lg p-3 border-2 border-teal-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition mb-6">
            <button id="start-game-btn" class="w-full max-w-sm mx-auto bg-teal-500 text-white font-bold py-3 px-6 rounded-lg text-xl hover:bg-teal-600 transition-transform transform hover:scale-105 shadow-md">B·∫Øt ƒë·∫ßu!</button>
        </div>

        <!-- M√†n h√¨nh ch∆°i game -->
        <div id="game-screen" class="hidden">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <span class="text-gray-500">Ng∆∞·ªùi ch∆°i:</span>
                        <span id="player-name-display" class="font-bold text-teal-700 text-lg"></span>
                    </div>
                    <div>
                        <span class="text-gray-500">ƒêi·ªÉm:</span>
                        <span id="score-display" class="font-bold text-green-600 text-lg">0</span>
                    </div>
                </div>

                <!-- Khu v·ª±c hi·ªÉn th·ªã t·ª´ b·ªã x√°o tr·ªôn -->
                <div id="letter-buttons-container" class="flex flex-wrap justify-center items-center gap-2 mb-6 min-h-[80px] bg-gray-100 p-4 rounded-lg">
                    <!-- C√°c n√∫t ch·ªØ c√°i s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
                </div>
                
                <!-- Khu v·ª±c g·ª£i √Ω -->
                <div id="hint-container" class="text-center min-h-[30px] mb-6">
                     <p id="hint-display" class="text-lg text-blue-600 font-medium"></p>
                </div>

                <!-- N√∫t ƒëi·ªÅu khi·ªÉn -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="hint-btn" class="flex-1 bg-amber-400 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-amber-500 transition shadow-md select-none">üí° G·ª£i √Ω</button>
                    <button id="restart-game-btn" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-red-600 transition shadow-md">üîÑ Ch∆°i l·∫°i</button>
                </div>
            </div>
        </div>

        <!-- M√†n h√¨nh k·∫øt th√∫c -->
        <div id="end-screen" class="hidden text-center relative bg-white p-8 rounded-2xl shadow-xl">
            <canvas id="fireworks-canvas"></canvas>
            <h2 class="text-4xl font-bold text-green-500 mb-4">Ch√∫c M·ª´ng!</h2>
            <p id="end-message" class="text-xl text-gray-700 mb-2"></p>
            <p class="text-2xl text-gray-800 mb-6">ƒêi·ªÉm cu·ªëi c√πng c·ªßa b·∫°n l√†: <span id="final-score" class="font-bold text-green-600"></span></p>
            <button id="play-again-btn" class="bg-teal-500 text-white font-bold py-3 px-8 rounded-lg text-xl hover:bg-teal-600 transition-transform transform hover:scale-105 shadow-md">Ch∆°i ti·∫øp</button>
        </div>

    </div>

    <!-- Modal th√¥ng b√°o -->
    <div id="custom-alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-sm">
            <p id="modal-message" class="text-lg mb-6 text-gray-700"></p>
            <button id="modal-ok-btn" class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition">OK</button>
        </div>
    </div>

    <script>
        // --- D·ªØ li·ªáu t·ª´ v·ª±ng ---
        const wordData = [
            { en: 'beautiful', vi: 'ƒë·∫πp' }, { en: 'ugly', vi: 'x·∫•u' }, { en: 'thin', vi: 'g·∫ßy' }, { en: 'fat', vi: 'm·∫≠p' }, 
            { en: 'big', vi: 'to' }, { en: 'small', vi: 'nh·ªè' }, { en: 'clean', vi: 's·∫°ch' }, { en: 'dirty', vi: 'b·∫©n' }, 
            { en: 'sad', vi: 'bu·ªìn' }, { en: 'happy', vi: 'vui' }, { en: 'short', vi: 'ng·∫Øn/th·∫•p' }, { en: 'long', vi: 'd√†i' },
            { en: 'bear', vi: 'con g·∫•u' }, { en: 'bird', vi: 'con chim' }, { en: 'cat', vi: 'con m√®o' }, { en: 'chicken', vi: 'con g√†' }, 
            { en: 'crocodile', vi: 'c√° s·∫•u' }, { en: 'hippo', vi: 'h√† m√£' }, { en: 'dog', vi: 'con ch√≥' }, { en: 'dolphin', vi: 'c√° heo' }, 
            { en: 'duck', vi: 'con v·ªãt' }, { en: 'elephant', vi: 'con voi' }, { en: 'fish', vi: 'con c√°' }, { en: 'giraffe', vi: 'h∆∞∆°u cao c·ªï' }, 
            { en: 'horse', vi: 'con ng·ª±a' }, { en: 'lion', vi: 's∆∞ t·ª≠' }, { en: 'monkey', vi: 'con kh·ªâ' }, { en: 'mouse', vi: 'con chu·ªôt' }, 
            { en: 'snake', vi: 'con r·∫Øn' }, { en: 'tiger', vi: 'con h·ªï' },
            { en: 'arm', vi: 'c√°nh tay' }, { en: 'ear', vi: 'c√°i tai' }, { en: 'eye', vi: 'm·∫Øt' }, { en: 'face', vi: 'khu√¥n m·∫∑t' }, 
            { en: 'foot', vi: 'b√†n ch√¢n' }, { en: 'feet', vi: 'nhi·ªÅu b√†n ch√¢n' }, { en: 'hair', vi: 't√≥c' }, { en: 'hand', vi: 'b√†n tay' }, 
            { en: 'head', vi: 'c√°i ƒë·∫ßu' }, { en: 'leg', vi: 'c√°i ch√¢n' }, { en: 'mouth', vi: 'mi·ªáng' }, { en: 'neck', vi: 'c·ªï' }, 
            { en: 'nose', vi: 'm≈©i' }, { en: 'shoulder', vi: 'vai' }, { en: 'tail', vi: 'ƒëu√¥i' }, { en: 'tooth', vi: 'rƒÉng' }, 
            { en: 'teeth', vi: 'nhi·ªÅu c√°i rƒÉng' },
            { en: 'dress', vi: 'v√°y' }, { en: 'hat', vi: 'm≈©' }, { en: 'jacket', vi: '√°o kho√°c' }, { en: 'shirt', vi: '√°o s∆° mi' }, 
            { en: 'shoes', vi: 'gi√†y' }, { en: 'shorts', vi: 'qu·∫ßn ƒë√πi' }, { en: 'skirt', vi: 'ch√¢n v√°y' }, { en: 'socks', vi: 't·∫•t/v·ªõ' }, 
            { en: 'sweater', vi: '√°o len' }, { en: 'trousers', vi: 'qu·∫ßn d√†i' }, { en: 't-shirt', vi: '√°o thun' },
            { en: 'bike', vi: 'xe ƒë·∫°p' }, { en: 'boat', vi: 'thuy·ªÅn' }, { en: 'bus', vi: 'xe bu√Ωt' }, { en: 'helicopter', vi: 'tr·ª±c thƒÉng' }, 
            { en: 'lorry', vi: 'xe t·∫£i' }, { en: 'car', vi: 'xe h∆°i' }, { en: 'motorbike', vi: 'xe m√°y' }, { en: 'plane', vi: 'm√°y bay' }, 
            { en: 'train', vi: 't√†u h·ªèa' }
        ];

        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const playerNameInput = document.getElementById('player-name-input');
        const startGameBtn = document.getElementById('start-game-btn');
        const playerNameDisplay = document.getElementById('player-name-display');
        const scoreDisplay = document.getElementById('score-display');
        const letterButtonsContainer = document.getElementById('letter-buttons-container');
        const hintBtn = document.getElementById('hint-btn');
        const hintDisplay = document.getElementById('hint-display');
        const restartGameBtn = document.getElementById('restart-game-btn');
        const endMessage = document.getElementById('end-message');
        const finalScore = document.getElementById('final-score');
        const playAgainBtn = document.getElementById('play-again-btn');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');

        // --- Game State ---
        let playerName = '';
        let score = 0;
        let currentWordIndex = 0;
        let shuffledWords = [];
        let currentWord = {};
        let mistakes = 0;
        let isProcessing = false;

        // --- √Çm thanh ---
        const correctSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.5 } }).toDestination();
        correctSound.volume.value = -12; 
        const wrongSound = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();

        function playCorrectSound() { Tone.start(); correctSound.triggerAttackRelease('C5', '8n', Tone.now()); correctSound.triggerAttackRelease('G5', '8n', Tone.now() + 0.2); }
        function playWrongSound() { Tone.start(); wrongSound.triggerAttackRelease('G#3', '8n', Tone.now()); wrongSound.triggerAttackRelease('G3', '8n', Tone.now() + 0.1); }

        // --- Modal ---
        let modalCallback = null;
        function showAlert(message, callback) {
            modalMessage.textContent = message;
            customAlertModal.classList.remove('hidden');
            modalCallback = callback;
        }
        modalOkBtn.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
            if (modalCallback) {
                modalCallback();
                modalCallback = null;
            }
        });

        // --- Text-to-Speech ---
        function speakWord(word) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
                utterance.onend = () => {
                    const utterance2 = new SpeechSynthesisUtterance(word);
                    utterance2.lang = 'en-US';
                    utterance2.rate = 0.9;
                    speechSynthesis.speak(utterance2);
                    utterance2.onend = () => setTimeout(nextWord, 500);
                };
            } else {
                 setTimeout(nextWord, 1000);
            }
        }

        // --- Game Logic ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateWordWithExtraLetters(word) {
            const wordLetters = word.split('').map(char => ({ char, isCorrect: true }));
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            const extraLettersCount = word.length < 5 ? 1 : 2;
            
            const finalLetters = [...wordLetters];
            let usedExtra = [];

            for (let i = 0; i < extraLettersCount; i++) {
                let randomLetter;
                do {
                    randomLetter = alphabet[Math.floor(Math.random() * alphabet.length)];
                } while (word.includes(randomLetter) || usedExtra.includes(randomLetter));
                usedExtra.push(randomLetter);

                const extraLetterObject = { char: randomLetter, isCorrect: false };
                const randomIndex = Math.floor(Math.random() * (finalLetters.length + 1));
                finalLetters.splice(randomIndex, 0, extraLetterObject);
            }
            return finalLetters;
        }
        
        function startGame() {
            playerName = playerNameInput.value || 'Ng∆∞·ªùi ch∆°i';
            score = 0;
            currentWordIndex = -1;
            shuffledWords = shuffleArray([...wordData]);
            
            playerNameDisplay.textContent = playerName;
            scoreDisplay.textContent = score;
            
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            nextWord();
        }

        function nextWord() {
            isProcessing = false;
            currentWordIndex++;
            if (currentWordIndex >= shuffledWords.length) {
                endGame();
                return;
            }
            
            currentWord = shuffledWords[currentWordIndex];
            mistakes = 0;
            hintDisplay.textContent = '';
            
            const letterObjects = generateWordWithExtraLetters(currentWord.en);
            letterButtonsContainer.innerHTML = '';
            letterButtonsContainer.classList.remove('correct-word');
            
            letterObjects.forEach(letterObj => {
                const button = document.createElement('button');
                button.textContent = letterObj.char.toUpperCase();
                button.dataset.isCorrect = letterObj.isCorrect;
                button.classList.add('letter-btn', 'w-12', 'h-16', 'text-2xl', 'font-bold', 'bg-white', 'text-teal-600', 'rounded-lg', 'shadow-md', 'border-teal-300');
                if (letterObj.char === ' ' || letterObj.char === '-') {
                    button.style.visibility = 'hidden';
                }
                button.onclick = () => handleLetterClick(button);
                letterButtonsContainer.appendChild(button);
            });
        }

        function handleLetterClick(button) {
            if (isProcessing || button.classList.contains('removed')) return;

            const isCorrectLetter = button.dataset.isCorrect === 'true';

            if (isCorrectLetter) {
                // Clicked a correct letter -> MISTAKE
                isProcessing = true;
                mistakes++;
                playWrongSound();
                button.classList.add('incorrect');

                setTimeout(() => {
                    button.classList.remove('incorrect');
                    if (mistakes >= 1) { // Ch·ªâ cho ph√©p sai 1 l·∫ßn
                        showAlert("·ªê ·ªì! Sai r·ªìi. T·ª´ ƒë√∫ng s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã.", () => {
                            revealAnswerAndProceed();
                        });
                    } else {
                        isProcessing = false;
                    }
                }, 500);

            } else {
                // Clicked an incorrect letter -> CORRECT MOVE
                button.classList.add('removed');
                
                const allIncorrectRemoved = Array.from(letterButtonsContainer.children)
                    .filter(btn => btn.dataset.isCorrect === 'false')
                    .every(btn => btn.classList.contains('removed'));

                if (allIncorrectRemoved) {
                    isProcessing = true;
                    score++;
                    scoreDisplay.textContent = score;
                    letterButtonsContainer.classList.add('correct-word');
                    
                    hintDisplay.innerHTML = `<span class="font-bold">${currentWord.en}</span>: ${currentWord.vi}`;

                    playCorrectSound();
                    setTimeout(() => speakWord(currentWord.en), 400);
                }
            }
        }

        function revealAnswerAndProceed() {
            Array.from(letterButtonsContainer.children).forEach(btn => {
                if (btn.dataset.isCorrect === 'true') {
                    btn.classList.add('bg-green-200');
                } else {
                    btn.classList.add('bg-red-500', 'text-white');
                }
            });
            setTimeout(nextWord, 2000);
        }
        
        function showHint() {
            hintDisplay.innerHTML = `<span class="font-bold">${currentWord.en}</span>: ${currentWord.vi}`;
        }
        
        function hideHint() {
            if (!letterButtonsContainer.classList.contains('correct-word')) {
                hintDisplay.innerHTML = '';
            }
        }

        function endGame() {
            gameScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            endMessage.textContent = `Tuy·ªát v·ªùi, ${playerName}!`;
            finalScore.textContent = score;
            startFireworks();
        }

        function resetGame() {
            gameScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            stopFireworks();
        }

        // --- Event Listeners ---
        startGameBtn.addEventListener('click', startGame);
        playerNameInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') startGame();
        });
        
        hintBtn.addEventListener('mousedown', showHint);
        hintBtn.addEventListener('mouseup', hideHint);
        hintBtn.addEventListener('mouseleave', hideHint);
        hintBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            showHint();
        });
        hintBtn.addEventListener('touchend', hideHint);
        
        restartGameBtn.addEventListener('click', resetGame);
        playAgainBtn.addEventListener('click', resetGame);
        
        // --- Hi·ªáu ·ª©ng ph√°o hoa (gi·ªØ nguy√™n) ---
        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        let fireworks = [], particles = [], animationFrameId;

        function setupCanvas() {
            if (!canvas.parentElement) return;
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }

        function Firework(sx, sy, tx, ty){ this.x = sx; this.y = sy; this.sx = sx; this.sy = sy; this.tx = tx; this.ty = ty; this.distanceToTarget = Math.sqrt(Math.pow(tx - sx, 2) + Math.pow(ty - sy, 2)); this.distanceTraveled = 0; this.coordinates = []; this.coordinateCount = 3; while( this.coordinateCount-- ) { this.coordinates.push( [ this.x, this.y ] ); } this.angle = Math.atan2( ty - sy, tx - sx ); this.speed = 2; this.acceleration = 1.05; this.brightness = Math.random() * 50 + 50; this.targetRadius = 1; }
        Firework.prototype.update = function( index ) { this.coordinates.pop(); this.coordinates.unshift( [ this.x, this.y ] ); if( this.targetRadius < 8 ) { this.targetRadius += 0.3; } else { this.targetRadius = 1; } this.speed *= this.acceleration; var vx = Math.cos( this.angle ) * this.speed; var vy = Math.sin( this.angle ) * this.speed; this.distanceTraveled = Math.sqrt(Math.pow(this.x - this.sx, 2) + Math.pow(this.y - this.sy, 2)); if( this.distanceTraveled >= this.distanceToTarget ) { createParticles( this.tx, this.ty ); fireworks.splice( index, 1 ); } else { this.x += vx; this.y += vy; } };
        Firework.prototype.draw = function() { ctx.beginPath(); ctx.moveTo( this.coordinates[ this.coordinates.length - 1 ][ 0 ], this.coordinates[ this.coordinates.length - 1 ][ 1 ] ); ctx.lineTo( this.x, this.y ); ctx.strokeStyle = 'hsl(' + Math.random() * 360 + ', 100%, ' + this.brightness + '%)'; ctx.stroke(); };
        function Particle( x, y ) { this.x = x; this.y = y; this.coordinates = []; this.coordinateCount = 5; while( this.coordinateCount-- ) { this.coordinates.push( [ this.x, this.y ] ); } this.angle = Math.random() * Math.PI * 2; this.speed = Math.random() * 10 + 1; this.friction = 0.95; this.gravity = 1; this.hue = Math.random() * 360; this.brightness = Math.random() * 50 + 50; this.alpha = 1; this.decay = Math.random() * 0.03 + 0.015; }
        Particle.prototype.update = function( index ) { this.coordinates.pop(); this.coordinates.unshift( [ this.x, this.y ] ); this.speed *= this.friction; this.x += Math.cos( this.angle ) * this.speed; this.y += Math.sin( this.angle ) * this.speed + this.gravity; this.alpha -= this.decay; if( this.alpha <= this.decay ) { particles.splice( index, 1 ); } };
        Particle.prototype.draw = function() { ctx.beginPath(); ctx.moveTo( this.coordinates[ this.coordinates.length - 1 ][ 0 ], this.coordinates[ this.coordinates.length - 1 ][ 1 ] ); ctx.lineTo( this.x, this.y ); ctx.strokeStyle = 'hsla(' + this.hue + ', 100%, ' + this.brightness + '%, ' + this.alpha + ')'; ctx.stroke(); };
        function createParticles( x, y ) { var particleCount = 30; while( particleCount-- ) { particles.push( new Particle( x, y ) ); } }
        function loop() { animationFrameId = requestAnimationFrame(loop); ctx.globalCompositeOperation = 'destination-out'; ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.globalCompositeOperation = 'lighter'; var i = fireworks.length; while(i--) { fireworks[i].draw(); fireworks[i].update(i); } var i = particles.length; while(i--) { particles[i].draw(); particles[i].update(i); } }
        let fireworkInterval;
        function startFireworks() { setupCanvas(); loop(); fireworkInterval = setInterval(() => { if (fireworks.length < 5) { var sx = canvas.width / 2; var sy = canvas.height; var tx = Math.random() * canvas.width; var ty = Math.random() * canvas.height / 2; fireworks.push(new Firework(sx, sy, tx, ty)); } }, 800); }
        function stopFireworks() { cancelAnimationFrame(animationFrameId); clearInterval(fireworkInterval); fireworks = []; particles = []; ctx.clearRect(0, 0, canvas.width, canvas.height); }
        window.addEventListener('resize', setupCanvas);

    </script>
</body>
</html>
